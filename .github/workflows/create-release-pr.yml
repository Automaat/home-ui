name: Create Release PR

# Requires PAT_TOKEN secret with repo scope to trigger workflows on created PR
# Without PAT_TOKEN, workflow runs but created PR won't trigger CI checks
# Create token at: https://github.com/settings/tokens/new?scopes=repo&description=Release%20PR%20Workflow

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: 'Version bump type (ignored if manual_version is set)'
        required: false
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - major
      manual_version:
        description: 'Manual version (e.g., 1.2.3) - overrides version_bump'
        required: false
        type: string

concurrency:
  group: create-release-pr
  cancel-in-progress: false

jobs:
  create-release-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          ref: main

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: '24'
          cache: 'npm'

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Validate and determine version
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version: $CURRENT_VERSION"

          if [ -n "${{ inputs.manual_version }}" ]; then
            # Strip 'v' prefix if present
            NEW_VERSION=$(echo "${{ inputs.manual_version }}" | sed 's/^v//')
            echo "Using manual version: $NEW_VERSION"

            # Validate semver format
            if ! echo "$NEW_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$'; then
              echo "Error: Invalid semver format: $NEW_VERSION"
              exit 1
            fi
          else
            # Calculate next version
            echo "Calculating ${{ inputs.version_bump }} version bump"
            npm version "${{ inputs.version_bump }}" --no-git-tag-version > /dev/null
            NEW_VERSION=$(node -p "require('./package.json').version")
            # Reset package.json for later clean bump
            git checkout package.json package-lock.json
          fi

          # Check if version already exists
          if [ "$NEW_VERSION" = "$CURRENT_VERSION" ]; then
            echo "Error: Version $NEW_VERSION is same as current version"
            exit 1
          fi

          # Check if tag already exists
          if git rev-parse "v$NEW_VERSION" >/dev/null 2>&1; then
            echo "Error: Tag v$NEW_VERSION already exists"
            exit 1
          fi

          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"

      - name: Create release branch
        run: |
          git checkout -b release/v${{ steps.version.outputs.version }}

      - name: Bump version
        run: |
          npm version "${{ steps.version.outputs.version }}" --no-git-tag-version

      - name: Commit version bump
        run: |
          git add package.json package-lock.json
          git commit -s -m "chore: bump version to ${{ steps.version.outputs.version }}"

          # Delete remote branch if it exists (handles reruns)
          if git ls-remote --exit-code --heads origin release/v${{ steps.version.outputs.version }} >/dev/null 2>&1; then
            echo "Remote branch exists, deleting..."
            git push origin --delete release/v${{ steps.version.outputs.version }}
          fi

          git push origin release/v${{ steps.version.outputs.version }}

      - name: Create pull request
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --title "Release v${{ steps.version.outputs.version }}" \
            --body "$(cat <<'EOF' | sed 's/^          //'
          ## Release v${{ steps.version.outputs.version }}

          This PR bumps the version to ${{ steps.version.outputs.version }}.

          ### Changes
          - Version bumped in package.json
          - package-lock.json updated

          ### Checklist
          - [ ] Changelog updated (if applicable)
          - [ ] Version number is correct
          - [ ] Ready to publish

          Merging this PR will automatically publish the package to npm.
          EOF
          )" \
            --base main \
            --head "release/v${{ steps.version.outputs.version }}")

          echo "pr-url=$PR_URL" >> "$GITHUB_OUTPUT"
          echo "Pull request created: $PR_URL"

      - name: Summary
        run: |
          {
            echo "## Release PR Created :rocket:"
            echo ""
            echo "- **Version**: ${{ steps.version.outputs.version }}"
            echo "- **PR**: ${{ steps.create-pr.outputs.pr-url }}"
            echo ""
            echo "Merge the PR to automatically publish to npm."
          } >> "$GITHUB_STEP_SUMMARY"
